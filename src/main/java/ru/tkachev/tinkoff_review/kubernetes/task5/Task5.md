# Kubernetes - Задание №5

### Сущность cron jobs<br/><br/>

`Job` — это yaml-манифест, который создаёт под для выполнения разовой задачи. 
Если запуск задачи завершается с ошибкой, `Job` перезапускает поды до успешного 
выполнения или до истечения таймаутов. Когда задача выполнена, `Job` считается 
завершённым и больше никогда в кластере не запускается. `Job` — это сущность для разовых задач.

`Job` будет создавать поды до тех пор, пока под не завершится с успешным результатом. 
Это значит, что если в поде есть ошибка, которая приводит к неуспешному результату 
(`exit code` не равен 0), то `Job` будет пересоздавать этот под до бесконечности. 
Чтобы ограничить перезапуски, в описании `Job` есть два таймаута: 
`activeDeadlineSeconds` и `backoffLimit`.

* `activeDeadlineSeconds` — количество секунд, которое отводится всему `Job` 
на выполнение. Это ограничение не для одного пода или одной попытки запуска, 
а для всего `Job`.

* `backoffLimit` — количество попыток.

Параметр `backoffLimit` очень важен, потому что, если его не задать, контроллер 
будет создавать поды бесконечно. А ведь чем больше объектов в кластере, 
тем больше ресурсов API нужно серверам, и что самое главное: каждый такой 
под — это как минимум два контейнера в остановленном состоянии на узлах кластера.

После успешного завершения задания манифесты `Job` и подов, созданных им, 
остаются в кластере навсегда. Все поля `Job` имеют статус `Immutable`, 
то есть «неизменяемый», и поэтому обычно при создании `Job` из различных 
автоматических сценариев сначала удаляют `Job`, который остался от 
предыдущего запуска.

Пример `Job`-манифеста:

```yaml
apiVersion: batch/v1
kind: Job
metadata:
  name: hello
spec:
  backoffLimit: 2
  activeDeadlineSeconds: 60
  template:
    spec:
      containers:
      - name: hello
        image: busybox
        args: 
        - /bin/sh
        - -c
        - date; echo Hello from the Kubernetes cluster
      restartPolicy: Never
```

В начале указаны название api-группы, тип сущности, имя и дальше — спецификация.

В спецификации указаны таймауты и темплейт пода, который будет запускаться. 
Опции `backoffLimit: 2` и `activeDeadlineSeconds: 60` означают, что `Job` будет 
пытаться выполнить задачу не более двух раз и в общей сложности не дольше 60 секунд.

`template` — это описание пода, который будет выполнять задачу;
в примере запускается простой контейнер `busybox`, который выводит текущую дату и 
передаёт привет из Kubernetes.

Job позволяет выполнить разовые задачи, но на практике постоянно возникает потребность 
выполнять что-то по расписанию. И вот здесь Kubernetes предлагает `CronJob`.

CronJob — это yaml-манифест, на основании которого по расписанию создаются 
`Job`’ы, которые в свою очередь создают поды, а те делают полезную работу.

В манифесте `CronJob` указывают расписание и ещё несколько важных параметров:

* `startingDeadlineSeconds`
* `concurrencyPolicy`
* `successfulJobsHistoryLimit`
* `failedJobsHistoryLimit`

Пример `CronJob`-манифеста:

```yaml
apiVersion: batch/v1beta1
kind: CronJob
metadata:
  name: hello
spec:
  schedule: "*/1 * * * *"
  concurrencyPolicy: Allow
  jobTemplate:
    spec:
      backoffLimit: 2
      activeDeadlineSeconds: 100
      template:
        spec:
          containers:
          - name: hello
            image: busybox
            args:
            - /bin/sh
            - -c
            - date; echo Hello from the Kubernetes cluster
          restartPolicy: Never
```

`schedule` — это расписание в виде строчки, которая имеет обычный cron-формат. 
Строчка в примере говорит о том, что `Job` должен выполняться раз в минуту.

`jobTemplate` — это шаблон, из которого создаётся объект `Job`.

`concurrencyPolicy` — этот параметр отвечает за одновременное выполнение заданий.
Бывает трёх видов: `Allow`, `Forbid`, `Replace`.

`Allow` позволяет подам запускаться. Если за минуту `Job` не отработал, 
все равно будет создан ещё один. Одновременно могут выполняться несколько `Job`’ов.

`Replace` заменяет запущенную нагрузку: старый `Job` убивается, запускается новый. 

`Forbid` запрещает запуск новых `Job`’ов, пока не отработает предыдущий. 
С этой политикой можно быть уверенным, что всегда запускается только один 
экземпляр задачи, поэтому `Forbid` используют наиболее часто.

В параметре `startingDeadlineSeconds` указывают количество секунд, 
на которое можно просрочить запуск `Job`. Если по каким-то причинам `Job` не 
создался и с момента, когда его надо было создать, прошло больше секунд, 
чем указано в этом параметре, то он и не будет создан. 
А если меньше, то хоть и с опозданием, `Job` будет создан.
